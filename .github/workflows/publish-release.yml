name: Publish and Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  publish:
    if: "!contains(github.event.head_commit.author.name, 'github-actions')"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      published: ${{ steps.publish.outputs.published }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Determine version to publish
        id: version
        run: |
          set -e
          
          CURRENT_VERSION=$(jq -r '.version' package.json)
          PKG_NAME=$(jq -r '.name' package.json)
          
          # Query published version from npm registry
          PUBLISHED_VERSION=$(npm view "$PKG_NAME" version 2>/dev/null || echo "0.0.0")
          
          echo "Current version in package.json: $CURRENT_VERSION"
          echo "Published version on npm: $PUBLISHED_VERSION"
          
          # Determine base version - use whichever is newer
          if [ "$CURRENT_VERSION" = "$PUBLISHED_VERSION" ]; then
            BASE_VERSION="$PUBLISHED_VERSION"
            NEEDS_BUMP=true
          else
            # Sort versions and use the higher one as base
            BASE_VERSION=$(printf '%s\n' "$CURRENT_VERSION" "$PUBLISHED_VERSION" | sort -V | tail -n1)
            if [ "$BASE_VERSION" != "$CURRENT_VERSION" ]; then
              NEEDS_BUMP=true
            else
              NEEDS_BUMP=false
            fi
          fi
          
          if [ "$NEEDS_BUMP" = "true" ]; then
            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
            NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
            
            # Update package.json
            jq --arg v "$NEW_VERSION" '.version = $v' package.json > package.json.tmp
            mv package.json.tmp package.json
            
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "bumped=true" >> $GITHUB_OUTPUT
            echo "Bumped version: $BASE_VERSION -> $NEW_VERSION"
          else
            echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "bumped=false" >> $GITHUB_OUTPUT
            echo "Version unchanged: $CURRENT_VERSION"
          fi

      - name: Commit version bump if needed
        if: steps.version.outputs.bumped == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
          git pull --rebase origin main
          git push origin main

      - name: Publish to npm
        id: publish
        run: |
          set -e
          npm publish
          echo "published=true" >> $GITHUB_OUTPUT
          echo "Successfully published v${{ steps.version.outputs.version }} to npm"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  build-portable:
    runs-on: windows-latest
    needs: publish
    if: needs.publish.outputs.published == 'true'
    outputs:
      portable-path: ${{ steps.build.outputs.portable-path }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: npm install

      - name: Build portable executable
        id: build
        env:
          NO_BUNDLE_MODELS: 'false'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          Write-Host "Starting portable build..."
          node build-portable.js
          
          # Detect build output directory
          $buildDir = Get-ChildItem -Path $PSScriptRoot.. -Directory -Filter "*agentgui*" -ErrorAction SilentlyContinue | Select-Object -First 1
          
          if ($null -eq $buildDir) {
            # Try alternative naming patterns
            $buildDir = Get-ChildItem -Path $PSScriptRoot.. -Directory -Filter "*agen*" -ErrorAction SilentlyContinue | Select-Object -First 1
          }
          
          if ($null -eq $buildDir) {
            # Last resort: check working directory
            $buildDir = Get-ChildItem -Path . -Directory -Filter "*agentgui*" -ErrorAction SilentlyContinue | Select-Object -First 1
          }
          
          if ($buildDir) {
            Write-Host "Found build directory: $($buildDir.FullName)"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "portable-path=$($buildDir.FullName)"
          } else {
            Write-Host "ERROR: Build directory not found"
            exit 1
          }

      - name: Create zip archive
        id: archive
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          
          $src = "${{ steps.build.outputs.portable-path }}"
          $zipName = "agentgui-v${{ needs.publish.outputs.version }}-windows-portable.zip"
          $dest = Join-Path ${{ github.workspace }} $zipName
          
          if (Test-Path $src) {
            Write-Host "Creating zip from: $src"
            Compress-Archive -Path "$src*" -DestinationPath $dest -Force
            Write-Host "Archive created: $dest"
            
            $size = [math]::Round((Get-Item $dest).Length / 1MB, 1)
            Write-Host "Archive size: ${size}MB"
            Add-Content -Path $env:GITHUB_OUTPUT -Value "archive=$dest"
          } else {
            Write-Host "ERROR: Build directory not found: $src"
            exit 1
          }

  create-release:
    runs-on: ubuntu-latest
    needs: [publish, build-portable]
    if: needs.publish.outputs.published == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
        continue-on-error: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.publish.outputs.version }}
          name: AgentGUI v${{ needs.publish.outputs.version }}
          body: |
            ## AgentGUI v${{ needs.publish.outputs.version }}

            Published to npm! Install with:
            ```bash
            bunx agentgui@latest
            npm install -g agentgui
            npx agentgui
            ```

            **Web interface**: http://localhost:3000/gm/

            **Notes**:
            - AI speech models (~477MB) are not bundled - they download automatically on first use
            - Data is stored in the `~/.gmgui/` folder
            - Requirements: Node.js 18+
          draft: false
          prerelease: false
          files: |
            release-artifacts/**/*.zip
