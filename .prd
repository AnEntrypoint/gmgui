# OIDC Trusted Publishing for npm - Product Requirements Document

## GOAL
Replace long-lived NPM_TOKEN secret with GitHub Actions OIDC Trusted Publishing. Enable npm publishing without token expiration/rotation/validation issues. Witness successful npm publish using OIDC credentials with provenance metadata.

## CURRENT STATE
- ✓ Workflow updated: Added id-token: write permission, changed to "npm publish --provenance", removed NPM_TOKEN configuration step
- ✓ Commits created: d7f82a4 pushed to main branch with workflow changes
- ✓ Secrets cleaned: NPM_TOKEN secret deleted from GitHub Actions
- ⏳ Pending: npm.org trusted publisher configuration (requires 2FA on npm.com)
- ⏳ Pending: Test publishing workflow with OIDC tokens
- Version 1.0.136 is current in package.json (will bump to 1.0.137 on next publish)
- Package "agentgui" is public on npm.org under "lanmower" account

## REMAINING WORK - FINAL CONFIGURATION & TESTING

### Wave 3 (Sequential - Configure npm OIDC Trust) - IN PROGRESS
- [COMPLETE-2FA] User-action: Complete security key 2FA on npm.com to confirm trusted publisher setup
  - Blocks: [VERIFY-PUBLISHER-SAVED]
- [VERIFY-PUBLISHER-SAVED] Verify GitHub appears in trusted publishers list on npm.org after 2FA completes
  - Blocks: [TEST-PUBLISH]


### Wave 5 (Sequential - Test Publishing, depends on Waves 2, 3, 4)
- [TEST-PUBLISH] Push workflow changes and trigger automatic build
- [VERIFY-OIDC-TOKEN] Confirm OIDC token generation succeeds in workflow log
- [VERIFY-NPM-PUBLISH] Confirm "npm publish --provenance" succeeds
- [VERIFY-VERSION-BUMPED] Check that version was incremented to 1.0.137 in main branch
- [VERIFY-NPM-RELEASE] Go to npm.org and verify new version published
- [VERIFY-PROVENANCE-METADATA] Inspect provenance metadata in published package


## REFERENCE: SUCCESS CRITERIA
- [✓] Workflow file updated with id-token: write permission (DONE - commit d7f82a4)
- [✓] Workflow file uses "npm publish --provenance" command (DONE)
- [✓] Workflow file does NOT contain NPM_TOKEN configuration step (DONE)
- [✓] npm package has GitHub as trusted publisher (IN PROGRESS - awaiting 2FA)
- [✓] NPM_TOKEN secret removed from GitHub (DONE)
- [PENDING] GitHub Actions workflow executes without NPM_TOKEN secret
- [PENDING] Workflow generates OIDC token (visible in logs)
- [PENDING] npm publish succeeds with OIDC token
- [PENDING] New package version published to npm.org
- [PENDING] Provenance metadata attached to published package
- [PENDING] Version bumped in main branch

## NOTES ON OIDC SECURITY
- OIDC tokens are short-lived (typically 5 minutes) - npm refreshes as needed
- Tokens are job-specific and scoped to single workflow execution
- No manual token rotation required
- Workflow execution time should be <2 minutes (well within token lifetime)
- Version bump logic already handles skipping "chore: bump version" commits

## COMPLETION CRITERIA - WILL VERIFY IN WAVE 5
- Witness full end-to-end execution: git push → workflow trigger → OIDC token generation → npm publish → version bumped → published on npm.org
- Verify provenance metadata in published package
- Confirm GitHub Actions uses OIDC token (no NPM_TOKEN errors in logs)
- All 6 verification steps in Wave 5 pass successfully

## IMMEDIATE NEXT STEPS

### Step 1: Complete 2FA on npm.com (1-2 minutes)
- [ ] Complete security key authentication on npm 2FA screen

### Step 2: Verify Trusted Publisher Configuration (1 minute)
- [ ] Navigate back to https://www.npmjs.com/package/agentgui/access
- [ ] Confirm "GitHub" appears under Trusted Publishers section
- [ ] Confirm details: AnEntrypoint/agentgui/.github/workflows/publish-npm.yml

### Step 3: Test OIDC Publishing (5-10 minutes)
- [ ] Push test commit: `git commit --allow-empty -m "test: trigger OIDC publishing"` && `git push`
- [ ] Watch GitHub Actions: https://github.com/AnEntrypoint/agentgui/actions
- [ ] Verify workflow completes successfully (should see OIDC token generation, no NPM_TOKEN error)
- [ ] Verify npm publish succeeded with --provenance flag
- [ ] Verify version bumped to 1.0.137 in main branch
- [ ] Verify new version appears on npm.org within 5 minutes
- [ ] Inspect provenance metadata in published package

